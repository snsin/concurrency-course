# Результаты #

Реализации [Auction](./Auction.java) с пессимистичными и оптимистичными блокировками.
- optimistic: 954 (606-1357)
- pessimistic: 991 (742-1282)

> Q: По нотифаеру - а почему ты выбрал такую реализацию?

A: Мне показалось, что она самая лаконичная и удовлетворяет требованиям: неблокирующая отправка сообщений.
Конечно, если быть честным, то это скорее подход: в любой непонятной ситуации выбирай CompletableFuture.
Однако, мне кажется, что здесь CompletableFuture подходит по требованиям, и думаю, что он обладает адекватными
настройками по умолчанию. Я считаю, что здесь разработчики java "подумали за меня" и грех было бы этим не 
воспользоваться. А если будет нужно изменить executor, например, после нагрузочного тестирования, то это будет
достаточно легко сделать. 

> По нотифаеру: у CF по умолчанию всё выполняется в ForkJoinPool.commonPool(). Там всего 7 потоков в 
> пуле(если ядер 8). Ранее мы разбирали разные подходящие настройки для разных типов задач,
> и тут прекрасное место, чтобы применить эти знания)

Переделал Notifier. Соображения следующие: нотификация - это блокирующая задача, а не вычислительная, т.к.
в тестовой реализации поток просто спит, а в реальной системе это скорее всего будет сетевое взаимодействие.
Учитывая предметную область - аукцион, можно ожидать, что нотификаций будет много, а точнее количество 
нотификаций будет приблизительно равняться количеству ставок. С такими вводными возможно применить fixedThreadPool,
при этом чем больше кол-во потоков, тем выше производительность, но и выше количество потребляемой памяти.
Поигрался с различным количеством потоков: 120 - 250 - 500 пула Notifier-а (цифры ниже), хотя, конечно,
количество наблюдений небольшое, результаты отличались не сильно. В итоге выбрал значение 120, т.к. время 
выполнения при каждом варианте приблизительно одинаковое, а вариант со 120 потоками в пуле наименее ресурсоемкий. 
В реальной системе постарался бы получить какую-нибудь начальную информацию об ожидаемом количестве ставок
и важности нотификаций, попробовал бы сформулировать дополнительные требования к нотификации и попытался оценить
сколько ресурсов понадобится. Но т.к. часто бывает, что заранее информации не много, то скорее всего выбрал бы 
кол-во потоков в районе 250 (т.е. примерно рядом с умолчаниями спринг-бута). Далее наблюдал бы за общими метриками
системы: потреблением памяти и ЦПУ, кол-вом трафика, и, если нотификации это важная часть системы, то за временем
выполнения нотификации и рейтом нотификаций. Исходя из полученной информации, делал бы выводы по тому в какую
сторону двигаться. В более простом варианте - увеличивать или уменьшать кол-во потоков в пуле. В более сложном,
например, если бы у нотификаций был какой-то паттерн нагрузки, допустим зависимость кол-ва от времени суток, либо
наличие редких пиков, делать более тонкие настройки, то, минимальное и максимальное кол-во потоков в пуле,
время жизни потока.

Ниже то что у меня получилось по цифрам:

120
optimistic: 2620 (1952-2924)
pessimistic: 2789 (2407-3187)

250
optimistic: 2798 (2511-3141)
pessimistic: 2774 (2442-3219)

500
optimistic: 2952 (2105-4470)
pessimistic: 2883 (2461-3229)

> Представим две крайности:
> 1) Наш приоритет - это ставки, процессор должен заниматься только ими, отправка нотификации имеет
> очень низкий приоритет.
> 2) Приоритет сервиса - нотификации, SLA доставки - 3 секунды. Ставки не особо важны
>
> Как в таком случае можно подобрать параметры экзекьютора?

В данном случае я бы подбирал настройки так:
1. Поскольку приоритет нотификаций низкий, то логично отдать экзекьютору 1 поток, пусть он медленно, 
   но верно их обрабатывает. Все остальные доступные потоки нужно использовать для обработки ставок.
   Дополнительно, в случае если ставок существенно больше чем участников и мы предполагаем, что участники сами 
   следят за ценой и делают ставки не дожидаясь нотификаций (мы можем так предположить, потому что API аукциона 
   содержит метод получения последней сделанной ставки и по т.з. приоритет нотификаций низкий) - т.е. участникам
   неважно дойдет ли до них нотификация об устаревшей ставке, то логично было бы ограничить размер очереди
   задач и применять политику `DiscardOldestPolicy()` для очереди задач.
2. В случае приоритета нотификаций следует применить Little’s Law: 
   кол-во потоков = число запросов в секунду * время обработки запроса в секундах. 
   В данном случае кол-во запросов будет пропорционально количеству ставок, а время обработки указано в
   задаче и составляет 2 секунды. При этом, если SLA 3 секунды, то число запросов я бы определил как bidsRate / 3,
   где bidsRate - кол-во ставок в секунду, 3 - кол-во секунд, за которое надо успеть обработать запрос.
   В данном случае я предполагаю, что каждая ставка больше предыдущей, соответственно генерируется запрос на
   нотификацию участника. На время выполнения данного запроса у нас есть 3 секунды, а длительность выполнения запроса
   составляет 2 секунды. В итоге получим формулу кол-ва потоков: bidsRate * 0.66(6). Ну и здесь я бы взял с запасом,
   например bidsRate * 0.8. Допустим, в системе делается 10 ставок в секунду, тогда по моим прикидкам, для обеспечения
   нужного SLA нотификаций потребуется 8 потоков.
   Дальнейшие действия зависели бы от того насколько мне известен характер нагрузки. Если известен слабо, то,
   чтобы обеспечить SLA я бы выделил под потоки максимально возможное число ресурсов, попробовал бы реализовать
   возможность настройки кол-ва потоков "на горячую", ну а дальше наблюдения и более точная настройка.
   При более подробной информации о характере ставок, например, если ставки интенсивно делаются в какой-то период
   времени, допустим с 19:00 до 20:00, можно было бы оптимизировать пул потоков задав небольшое начальное кол-во 
   потоков, максимальное кол-во потоков рассчитанное по формуле bidsRate * 0.8 и время жизни потока в 1 час, где
   значение bidsRate - максимальное число ставок в секунду.
